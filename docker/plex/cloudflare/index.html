



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Selfhosters.net is a documentation portal for the Unraid Discord. Here you will find short guides and walkthroughs made by the  Unraid community.">
      
      
        <link rel="canonical" href="https://selfhosters.net/docker/plex/cloudflare/">
      
      
        <meta name="author" content="Selfhosters">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.6.0">
    
    
      
        <title>Routing Plex through Cloudflare - Selfhosters.net</title>
      
    
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.1b62728e.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#fb8c00">
      
    
    <link rel="stylesheet" href="../../../css/lightgallery.min.css">

    
    
      <script src="../../../assets/javascripts/modernizr.268332fc.js"></script>
    
    <script src="../../../js/lightgallery.min.js"></script>

    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="red">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#routing-plex-through-cloudflare" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://selfhosters.net" title="Selfhosters.net" class="md-header-nav__button md-logo">
          
            <i class="md-icon">î Œ</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Selfhosters.net
            </span>
            <span class="md-header-nav__topic">
              
                Routing Plex through Cloudflare
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/selfhosters/selfhosters.net/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    selfhosters/selfhosters.net
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://selfhosters.net" title="Selfhosters.net" class="md-nav__button md-logo">
      
        <i class="md-icon">î Œ</i>
      
    </a>
    Selfhosters.net
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/selfhosters/selfhosters.net/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    selfhosters/selfhosters.net
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../commands/" title="Nice to know Unraid commands" class="md-nav__link">
      Nice to know Unraid commands
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Unraid Tips
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Unraid Tips
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tips/discord_notifications/discord_notifications/" title="Adding Discord Notifications" class="md-nav__link">
      Adding Discord Notifications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Docker
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Docker
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Telegraf
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Telegraf
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../telegraf/ipmi/" title="Adding IPMI stats to the Telegraf container" class="md-nav__link">
      Adding IPMI stats to the Telegraf container
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-2" type="checkbox" id="nav-4-2" checked>
    
    <label class="md-nav__link" for="nav-4-2">
      Plex
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-2">
        Plex
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Routing Plex through Cloudflare
      </label>
    
    <a href="./" title="Routing Plex through Cloudflare" class="md-nav__link md-nav__link--active">
      Routing Plex through Cloudflare
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why" class="md-nav__link">
    Why
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverse-proxy" class="md-nav__link">
    Reverse proxy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloudflare" class="md-nav__link">
    Cloudflare
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cache-rules" class="md-nav__link">
    Cache rules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-ipv6" class="md-nav__link">
    Disable IPv6
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plex" class="md-nav__link">
    Plex
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-server-access-urls" class="md-nav__link">
    Custom server access URLs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../templating/templating/" title="Writing a template compatible for unraid" class="md-nav__link">
      Writing a template compatible for unraid
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why" class="md-nav__link">
    Why
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverse-proxy" class="md-nav__link">
    Reverse proxy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloudflare" class="md-nav__link">
    Cloudflare
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cache-rules" class="md-nav__link">
    Cache rules
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-ipv6" class="md-nav__link">
    Disable IPv6
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plex" class="md-nav__link">
    Plex
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#custom-server-access-urls" class="md-nav__link">
    Custom server access URLs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/selfhosters/selfhosters.net/edit/master/docs/docker/plex/cloudflare.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="routing-plex-through-cloudflare">Routing Plex through Cloudflare<a class="headerlink" href="#routing-plex-through-cloudflare" title="Permanent link">&para;</a></h1>
<h2 id="why">Why<a class="headerlink" href="#why" title="Permanent link">&para;</a></h2>
<p>Routing Plex through the <a href="https://www.cloudflare.com/learning/cdn/what-is-a-cdn/">Cloudflare CDN</a> can vastly improve your remote connection speeds to your server. Cloudflare acts as a middle man between your server and your different clients.</p>
<p>Many experience bad peering between server and client even though the server has a good upload speed. This is because the client sometimes has to hop through all sorts of hoops if it's on a different ISP network. This can increase latency and lowered connection speeds.</p>
<p>But by using Cloudflare as a middle man, both your server and the clients will (in most cases) have a great connection to Cloudflare.</p>
<p>This will speed up the start times and scrolling of your streams and the general stability of the connection.</p>
<h3 id="reverse-proxy">Reverse proxy<a class="headerlink" href="#reverse-proxy" title="Permanent link">&para;</a></h3>
<p>To get this working you need to reverse proxy Plex. This guide won't go into detail on how to do this. But I highly recommend this guide as a starting point. <a href="https://blog.linuxserver.io/2019/04/25/letsencrypt-nginx-starter-guide/">Let's Encrypt, Nginx &amp; Reverse Proxy Starter Guide - 2019 Edition</a></p>
<p>The <a href="https://hub.docker.com/r/linuxserver/letsencrypt/">linuxserver/letsencrypt</a> container comes with premade nginx configs that you can use.
If you're stuck, just pop into the <mark>#reverse-proxy</mark> channel on our <a href="https://selfhosters.net/unraid">Discord</a> and someone will help you <img alt="ðŸ™‚" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f642.svg" title=":slight_smile:" /></p>
<details class="example"><summary>Nginx subdomain example</summary><div class="superfences-tabs">
<input name="__tabs_1" type="radio" id="__tab_1_0" checked="checked" />
<label for="__tab_1_0">plex.conf</label>
<div class="superfences-content"><div class="codehilite"><pre><span></span>    <span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:443</span> <span class="s">ssl</span><span class="p">;</span>

    <span class="kn">server_name</span> <span class="s">plex.*</span><span class="p">;</span>

    <span class="kn">include</span> <span class="s">/config/nginx/ssl.conf</span><span class="p">;</span>

    <span class="kn">client_max_body_size</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
    <span class="kn">proxy_buffering</span> <span class="no">off</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">include</span> <span class="s">/config/nginx/proxy.conf</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://HOSTIP:32400/</span><span class="p">;</span>

        <span class="kn">proxy_set_header</span> <span class="s">Upgrade</span> <span class="nv">$http_upgrade</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&quot;upgrade&quot;</span><span class="p">;</span>

        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Client-Identifier</span> <span class="nv">$http_x_plex_client_identifier</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Device</span> <span class="nv">$http_x_plex_device</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Device-Name</span> <span class="nv">$http_x_plex_device_name</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Platform</span> <span class="nv">$http_x_plex_platform</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Platform-Version</span> <span class="nv">$http_x_plex_platform_version</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Product</span> <span class="nv">$http_x_plex_product</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Token</span> <span class="nv">$http_x_plex_token</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Version</span> <span class="nv">$http_x_plex_version</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Nocache</span> <span class="nv">$http_x_plex_nocache</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Provides</span> <span class="nv">$http_x_plex_provides</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Device-Vendor</span> <span class="nv">$http_x_plex_device_vendor</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Plex-Model</span> <span class="nv">$http_x_plex_model</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div>
<input name="__tabs_1" type="radio" id="__tab_1_1" />
<label for="__tab_1_1">ssl.conf</label>
<div class="superfences-content"><div class="codehilite"><pre><span></span><span class="c1">## Version 2020/01/07 - Changelog: https://github.com/linuxserver/docker-letsencrypt/commits/master/root/defaults/ssl.conf</span>

<span class="c1"># session settings</span>
<span class="k">ssl_session_timeout</span> <span class="s">1d</span><span class="p">;</span>
<span class="k">ssl_session_cache</span> <span class="s">shared:SSL:50m</span><span class="p">;</span>
<span class="k">ssl_session_tickets</span> <span class="no">off</span><span class="p">;</span>

<span class="c1"># Diffie-Hellman parameter for DHE cipher suites</span>
<span class="k">ssl_dhparam</span> <span class="s">/config/nginx/dhparams.pem</span><span class="p">;</span>

<span class="c1"># ssl certs</span>
<span class="k">ssl_certificate</span> <span class="s">/config/keys/letsencrypt/fullchain.pem</span><span class="p">;</span>
<span class="k">ssl_certificate_key</span> <span class="s">/config/keys/letsencrypt/privkey.pem</span><span class="p">;</span>

<span class="c1"># protocols</span>
<span class="c1"># using generated 2020-01-07, https://ssl-config.mozilla.org/#server=nginx&amp;server-version=1.16.1-r4&amp;config=intermediate&amp;openssl-version=1.1.1d-r3</span>
<span class="k">ssl_protocols</span> <span class="s">TLSv1.2</span> <span class="s">TLSv1.3</span><span class="p">;</span>
<span class="k">ssl_ciphers</span> <span class="s">ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><span class="p">;</span>
<span class="k">ssl_prefer_server_ciphers</span> <span class="no">off</span><span class="p">;</span>

<span class="c1"># HSTS, remove # from the line below to enable HSTS</span>
<span class="c1">#add_header Strict-Transport-Security &quot;max-age=63072000; includeSubDomains; preload&quot; always;</span>

<span class="c1"># OCSP Stapling</span>
<span class="k">ssl_stapling</span> <span class="no">on</span><span class="p">;</span>
<span class="k">ssl_stapling_verify</span> <span class="no">on</span><span class="p">;</span>
<span class="k">resolver</span> <span class="mi">127</span><span class="s">.0.0.11</span> <span class="s">valid=30s</span><span class="p">;</span> <span class="c1"># Docker DNS Server</span>

<span class="c1"># Enable TLS 1.3 early data</span>
<span class="k">ssl_early_data</span> <span class="no">on</span><span class="p">;</span>

<span class="c1"># Optional additional headers</span>
<span class="c1">#add_header Content-Security-Policy &quot;upgrade-insecure-requests&quot;;</span>
<span class="c1">#add_header X-Frame-Options &quot;SAMEORIGIN&quot; always;</span>
<span class="c1">#add_header X-XSS-Protection &quot;1; mode=block&quot; always;</span>
<span class="c1">#add_header X-Content-Type-Options &quot;nosniff&quot; always;</span>
<span class="c1">#add_header X-UA-Compatible &quot;IE=Edge&quot; always;</span>
<span class="c1">#add_header Cache-Control &quot;no-transform&quot; always;</span>
<span class="c1">#add_header Referrer-Policy &quot;same-origin&quot; always;</span>
</pre></div></div>
<input name="__tabs_1" type="radio" id="__tab_1_2" />
<label for="__tab_1_2">proxy.conf</label>
<div class="superfences-content"><div class="codehilite"><pre><span></span><span class="c1">## Version 2019/10/23 - Changelog: https://github.com/linuxserver/docker-letsencrypt/commits/master/root/defaults/proxy.conf</span>

<span class="k">client_body_buffer_size</span> <span class="mi">128k</span><span class="p">;</span>

<span class="c1">#Timeout if the real server is dead</span>
<span class="k">proxy_next_upstream</span> <span class="s">error</span> <span class="s">timeout</span> <span class="s">invalid_header</span> <span class="s">http_500</span> <span class="s">http_502</span> <span class="s">http_503</span><span class="p">;</span>

<span class="c1"># Advanced Proxy Config</span>
<span class="k">send_timeout</span> <span class="mi">5m</span><span class="p">;</span>
<span class="k">proxy_read_timeout</span> <span class="mi">240</span><span class="p">;</span>
<span class="k">proxy_send_timeout</span> <span class="mi">240</span><span class="p">;</span>
<span class="k">proxy_connect_timeout</span> <span class="mi">240</span><span class="p">;</span>

<span class="c1"># TLS 1.3 early data</span>
<span class="k">proxy_set_header</span> <span class="s">Early-Data</span> <span class="nv">$ssl_early_data</span><span class="p">;</span>

<span class="c1"># Basic Proxy Config</span>
<span class="k">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="s">https</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">X-Forwarded-Host</span> <span class="nv">$host</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">X-Forwarded-Ssl</span> <span class="no">on</span><span class="p">;</span>
<span class="k">proxy_redirect</span>  <span class="s">http://</span>  <span class="nv">$scheme://</span><span class="p">;</span>
<span class="k">proxy_http_version</span> <span class="mi">1</span><span class="s">.1</span><span class="p">;</span>
<span class="k">proxy_set_header</span> <span class="s">Connection</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="c1">#proxy_cookie_path / &quot;/; HTTPOnly; Secure&quot;; # enable at your own risk, may break certain apps</span>
<span class="k">proxy_cache_bypass</span> <span class="nv">$cookie_session</span><span class="p">;</span>
<span class="k">proxy_no_cache</span> <span class="nv">$cookie_session</span><span class="p">;</span>
<span class="k">proxy_buffers</span> <span class="mi">32</span> <span class="mi">4k</span><span class="p">;</span>
<span class="k">proxy_headers_hash_bucket_size</span> <span class="mi">128</span><span class="p">;</span>
<span class="k">proxy_headers_hash_max_size</span> <span class="mi">1024</span><span class="p">;</span>
</pre></div></div>
</div>
</details>
<h3 id="cloudflare">Cloudflare<a class="headerlink" href="#cloudflare" title="Permanent link">&para;</a></h3>
<p>If you haven't already you need to add your domain to Cloudflare for this to work. See this guide on how to do that: <a href="https://support.cloudflare.com/hc/en-us/articles/201720164-Creating-a-Cloudflare-account-and-adding-a-website">Creating a Cloudflare account and adding a website</a></p>
<p>In short you need to change your nameservers on your DNS provides page to the ones Cloudflare says.
This might take some time depending on the DNS provider. Last time I did it I was using Namecheap and it took less then 10 minutes to propagate, so have some patience.</p>
<p>After it's been transfered make sure the orange cloud is enabled. This is what activates the Cloudflare CDN on the domain.</p>
<p><div class="lightgallery"><a href="../cloudflare_cloud.png"><img alt="!cloud" src="../cloudflare_cloud.png" /></a></div></p>
<h4 id="cache-rules">Cache rules<a class="headerlink" href="#cache-rules" title="Permanent link">&para;</a></h4>
<p>This is very important that you do or else Cloudflare might ban your account for breaking the TOS on caching.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>See: <a href="https://www.cloudflare.com/terms/">2.8 Limitation on Serving Non-HTML Content</a></p>
</div>
<p>Go to the <mark>Page Rules</mark> menu and click on <mark>Create page rule</mark>
You can have 3 page rules per domain.</p>
<p>Add your domain with a wildcard at the end like so: <code class="codehilite"><span class="err">plex.domain.com/*</span></code> If you're using your root domain you do the same. <code class="codehilite"><span class="err">domain.com/*</span></code> or <code class="codehilite"><span class="err">domain.com/plex*</span></code></p>
<p>If you want to add the rule on all subdomains you can do that so: <code class="codehilite"><span class="err">*.domain.com/</span></code></p>
<p>Next select the <mark>Cache Level</mark> setting and set it to <mark>Bypass</mark>
Then click <mark>Save and Deploy</mark></p>
<p><div class="lightgallery"><a href="../page_rules.png"><img alt="!Page Rules" src="../page_rules.png" /></a></div></p>
<h4 id="disable-ipv6">Disable IPv6<a class="headerlink" href="#disable-ipv6" title="Permanent link">&para;</a></h4>
<p>There is currently a <a href="https://forums.plex.tv/t/plex-api-sessions-status-not-honoring-x-forwarded-for-x-real-ip-with-ipv6-clients/175705">bug</a> in Plex that it sees remote IPv6 adresses as local when reverse proxied. And as Cloudflare uses IPv6 we can disable that using the Cloudflare API. (It's not possible through the webUI)</p>
<p>This bug won't affect performance, but any remote streams using IPv6 will show as local on the Plex dashboard and in Tautili. So this is more of an annoyance that we can easily fix.</p>
<p>Below is the command you need to run for disabling IPv6.</p>
<div class="codehilite"><pre><span></span>    curl -X PATCH <span class="s2">&quot;https://api.cloudflare.com/client/v4/zones/xxxxxxxxxxxxxxxxx/settings/ipv6&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Email: xxxxxxx@email.com&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;X-Auth-Key: xxxxxxxxxxxxxxxxxxxxx&quot;</span> <span class="se">\</span>
    -H <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="se">\</span>
    --data <span class="s1">&#39;{&quot;value&quot;:&quot;off&quot;}&#39;</span>
</pre></div>

<p>In the API URL replace the x's with you Zone ID for you domain. You can find the zone ID on the <mark>Overview</mark> page at the bottom.</p>
<p><div class="lightgallery"><a href="../zone_id.png"><img alt="!zone" src="../zone_id.png" /></a></div></p>
<p>On the second line add your email account you used for Cloudflare and on the third line add your <mark>Global API key</mark></p>
<p>The Global API key can be found on your profile page and then API Tokens.</p>
<p>Next just paste all the lines into the terminal and hit enter.</p>
<p>If successful, the output will look like this:</p>
<div class="codehilite"><pre><span></span>    <span class="p">{</span><span class="nt">&quot;result&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;ipv6&quot;</span><span class="p">,</span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;off&quot;</span><span class="p">,</span><span class="nt">&quot;modified_on&quot;</span><span class="p">:</span><span class="s2">&quot;2020-01-21T20:52:11.121560Z&quot;</span><span class="p">,</span><span class="nt">&quot;editable&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">},</span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nt">&quot;errors&quot;</span><span class="p">:[],</span><span class="nt">&quot;messages&quot;</span><span class="p">:[]}</span>
</pre></div>

<p>In the webui it should now say that IPv6 Compatibility is off.
<div class="lightgallery"><a href="../ipv6.png"><img alt="!ipv6" src="../ipv6.png" /></a></div></p>
<h3 id="plex">Plex<a class="headerlink" href="#plex" title="Permanent link">&para;</a></h3>
<h4 id="custom-server-access-urls">Custom server access URLs<a class="headerlink" href="#custom-server-access-urls" title="Permanent link">&para;</a></h4>
<p>After you've setup your reverse proxy for Plex and configured Cloudflare, go into your Plex settings and select <mark>Network</mark>.
Then click on <mark>Show Advanced</mark> and scroll down to <mark>Custom server access URLs</mark></p>
<p>Add your domain you setup for plex with the port 443 after like so: <code class="codehilite"><span class="c">https://plexdomain.com:443</span></code> or <code class="codehilite"><span class="c">https://plexdomain.com:443/plex</span></code>and hit save.</p>
<p><div class="lightgallery"><a href="../custom_url.png"><img alt="!domain" src="../custom_url.png" /></a></div></p>
<p>At this point you do not need to have <mark>Remote Access</mark> enabled anymore.</p>
<p>To test you can disable your <mark>Remote Access</mark> and try and stream something remotely.</p>
<p>After a little while you should see on the Cloudflare <mark>Overview</mark> page that the <mark>Total Data Served</mark> have increased.</p>
<p><div class="lightgallery"><a href="../cloudflare_overview.png"><img alt="!Overview" src="../cloudflare_overview.png" /></a></div></p>
<p>Happy streaming <img alt="ðŸ˜„" class="emojione" src="https://cdnjs.cloudflare.com/ajax/libs/emojione/2.2.7/assets/svg/1f604.svg" title=":smile:" /></p>
                
                  
                
                
                  
                  <hr>
                  <div class="md-source-date">
                    <small>
                      
                        Last update: January 28, 2020
                      
                    </small>
                  </div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../telegraf/ipmi/" title="Adding IPMI stats to the Telegraf container" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Adding IPMI stats to the Telegraf container
              </span>
            </div>
          </a>
        
        
          <a href="../../templating/templating/" title="Writing a template compatible for unraid" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Writing a template compatible for unraid
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/selfhosters" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://discord.gg/qWPbc8R" class="md-footer-social__link fa fa-discord"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
    
      <script src="../../../assets/javascripts/application.808e90bb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    
    <script>
    var elements = document.getElementsByClassName("lightgallery");
    for(var i=0; i<elements.length; i++) {
       lightGallery(elements[i]);
    }
    </script>

  </body>
</html>